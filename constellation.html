<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Multi Constellation Creator üåü</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background: radial-gradient(ellipse at bottom, #1b2735 0%, #090a0f 100%);
      font-family: Arial, sans-serif;
      color: white;
      touch-action: manipulation;
    }
    canvas {
      display: block;
      touch-action: none;
    }
    #messageBox, #contextMenu {
      position: absolute;
      background: rgba(255,255,255,0.95);
      color: #000;
      border-radius: 6px;
      padding: 8px;
      font-size: 14px;
      display: none;
      z-index: 10;
    }
    #contextMenu button {
      display: block;
      width: 100%;
      background: none;
      border: none;
      padding: 6px;
      text-align: left;
      cursor: pointer;
    }
    #contextMenu button:hover {
      background: #f0f0f0;
    }
    #closeBtn {
      position: absolute;
      top: 5px;
      right: 5px;
      background: #ff5555;
      color: white;
      border-radius: 50%;
      width: 25px;
      height: 25px;
      font-size: 18px;
      cursor: pointer;
      text-align: center;
      line-height: 25px;
    }
    #menuToggleBtn {
      position: absolute;
      top: 12px;
      left: 12px;
      z-index: 20;
      background: rgba(0,0,0,0.7);
      color: #fff;
      border: none;
      border-radius: 6px;
      width: 38px;
      height: 38px;
      font-size: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.2s;
    }
    #menuToggleBtn:hover {
      background: #222;
    }
    #controls {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0,0,0,0.6);
      padding: 10px;
      border-radius: 8px;
      z-index: 15;
      min-width: 210px;
      transition: opacity 0.2s;
      display: none;
    }
    button {
      background: #fff;
      border: none;
      border-radius: 5px;
      padding: 5px 10px;
      margin: 4px 0;
      font-size: 14px;
      cursor: pointer;
    }
    button:hover {
      background: #ffcccb;
    }
    #starInfo {
      position: absolute;
      background: rgba(0, 0, 0, 0.6);
      color: white;
      padding: 10px;
      font-size: 12px;
      border-radius: 5px;
      display: none;
      z-index: 15;
    }
    .highlighted {
      fill: #FF0 !important;
      stroke: #FF0 !important;
      stroke-width: 2;
    }
    .star {
      filter: drop-shadow(0 0 12px #fff) drop-shadow(0 0 24px #fff) drop-shadow(0 0 36px #ff0);
      transition: filter 0.2s;
    }
    @media (max-width: 600px) {
      #controls {
        top: 0;
        left: 0;
        width: 100vw;
        font-size: 4vw;
        padding: 4vw 2vw;
        border-radius: 0 0 12px 12px;
        min-width: unset;
      }
      button {
        font-size: 4vw;
        padding: 3vw 6vw;
      }
      #starInfo {
        font-size: 3vw;
        padding: 3vw;
      }
      #contextMenu, #messageBox {
        font-size: 4vw;
        padding: 3vw;
      }
      #closeBtn {
        width: 8vw;
        height: 8vw;
        font-size: 6vw;
        line-height: 8vw;
      }
      #menuToggleBtn {
        width: 12vw;
        height: 12vw;
        font-size: 7vw;
      }
    }
  </style>
</head>
<body>
<canvas id="sky"></canvas>
<div id="messageBox"></div>
<div id="contextMenu">
  <div id="starMenuSection" style="display:none;">
    <button onclick="editSelectedStar()">‚úèÔ∏è Edit Pesan</button>
    <button onclick="deleteSelectedStar()">üóëÔ∏è Hapus Bintang</button>
    <button onclick="startConnectingStars()">üîó Sambung Bintang</button>
    <button onclick="deleteConnectionsOfStar()">‚ùå Hapus Sambungan</button>
    <hr>
  </div>
  <div id="constellationMenuSection" style="display:none;">
    <button onclick="promptConstellationName()">‚ûï Nama Rasi</button>
    <button onclick="removeConstellationName()">üóëÔ∏è Hapus Nama Rasi</button>
    <button onclick="changeConstellationColor()">üåà Ganti Warna Nama</button>
    <button onclick="toggleConstellationName()" id="toggleNameGroupBtn">üôà Sembunyikan Nama Rasi Ini</button>
  </div>
  <div id="closeBtn" onclick="hideContextMenu()">X</div>
</div>
<!-- Hamburger/Close Button -->
<button id="menuToggleBtn" onclick="toggleControls()">&#9776;</button>
<!-- Menu Controls -->
<div id="controls">
  ‚ú® 2x Tap/DblClick pada bintang untuk kelola bintang/rasi<br>
  <button onclick="resetStars()">üîÑ Reset Semua</button>
  <button onclick="toggleAllConstellationNames()" id="toggleNamesBtn">üôà Sembunyikan Semua Nama Rasi</button>
</div>
<div id="starInfo"></div>
<script type="module">
const canvas = document.getElementById("sky");
const ctx = canvas.getContext("2d");
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

let stars = []; // {x, y, message}
let connections = []; // [indexA, indexB]
let groupData = []; // [{name, color, visible:true}]
let cachedGroups = null; // agar tidak hitung ulang terus

let selectedStar = null;
let firstStar = null;
let contextStar = null;
let contextGroupIdx = null;

const messageBox = document.getElementById("messageBox");
const contextMenu = document.getElementById("contextMenu");
const starMenuSection = document.getElementById("starMenuSection");
const constellationMenuSection = document.getElementById("constellationMenuSection");
const controls = document.getElementById("controls");
const menuToggleBtn = document.getElementById("menuToggleBtn");
const starInfo = document.getElementById("starInfo");
const toggleNamesBtn = document.getElementById("toggleNamesBtn");

function toggleControls() {
  if (controls.style.display === "none" || controls.style.display === "") {
    controls.style.display = "block";
    menuToggleBtn.innerHTML = "&times;";
  } else {
    controls.style.display = "none";
    menuToggleBtn.innerHTML = "&#9776;";
  }
}
controls.style.display = "none";
menuToggleBtn.innerHTML = "&#9776;";

// --- Grup/rasi detection ---
function detectGroups() {
  let visited = new Array(stars.length).fill(false);
  let groups = [];
  let starToGroup = new Array(stars.length).fill(null);

  for (let i = 0; i < stars.length; i++) {
    if (!visited[i]) {
      let group = [];
      let queue = [i];
      visited[i] = true;
      while (queue.length) {
        let curr = queue.shift();
        group.push(curr);
        connections.forEach(([a, b]) => {
          if (a === curr && !visited[b]) { visited[b] = true; queue.push(b); }
          if (b === curr && !visited[a]) { visited[a] = true; queue.push(a); }
        });
      }
      if (group.length > 1) { // hanya grup yang punya koneksi
        groups.push(group);
        group.forEach(idx => starToGroup[idx] = groups.length - 1);
      }
    }
  }
  cachedGroups = { groups, starToGroup };
  // pad groupData jika kurang
  while (groupData.length < groups.length) {
    groupData.push({
      name: "",
      color: "#FFD700",
      visible: true,
    });
  }
  return { groups, starToGroup };
}

// --- DRAW ---
function draw() {
  ctx.setTransform(1, 0, 0, 1, 0, 0);
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  const { groups, starToGroup } = detectGroups();

  // Draw all connections per group
  groups.forEach((group, groupIdx) => {
    if (!groupData[groupIdx] || !groupData[groupIdx].visible) return;
    ctx.strokeStyle = "rgba(255,255,255,0.3)";
    ctx.lineWidth = 1.5;
    group.forEach(idxA => {
      connections.forEach(([a, b]) => {
        if (a === idxA && group.includes(b)) {
          ctx.beginPath();
          ctx.moveTo(stars[a].x, stars[a].y);
          ctx.lineTo(stars[b].x, stars[b].y);
          ctx.stroke();
        }
      });
    });
  });

  // Draw all stars
  stars.forEach((star, i) => {
    ctx.save();
    ctx.shadowColor = "#fff";
    ctx.shadowBlur = 18;
    ctx.beginPath();
    ctx.arc(star.x, star.y, 5, 0, Math.PI * 2);
    ctx.fillStyle = "white";
    ctx.fill();
    ctx.restore();
  });

  // Draw rasi name di atas bounding box masing-masing grup
  groups.forEach((group, groupIdx) => {
    const gdata = groupData[groupIdx];
    if (!gdata || !gdata.visible || !gdata.name) return;
    // ambil koordinat semua bintang dalam grup
    const xs = group.map(idx => stars[idx].x);
    const ys = group.map(idx => stars[idx].y);
    const minX = Math.min(...xs), maxX = Math.max(...xs);
    const topY = Math.min(...ys);
    const centerX = (minX + maxX) / 2;
    const nameOffset = 25;

    ctx.save();
    ctx.font = "bold 26px Arial";
    ctx.fillStyle = gdata.color || "#FFD700";
    ctx.textAlign = "center";
    ctx.textBaseline = "bottom";
    ctx.shadowColor = "#000";
    ctx.shadowBlur = 8;
    ctx.globalAlpha = 0.95;
    ctx.fillText(gdata.name, centerX, topY - nameOffset);
    ctx.restore();
  });
  updateToggleNamesBtn();
}

// --- Toggle All Names ---
function toggleAllConstellationNames() {
  let anyVisible = groupData.some(g => g.visible !== false);
  groupData.forEach(g => g.visible = !anyVisible);
  draw();
  updateToggleNamesBtn();
}
function updateToggleNamesBtn() {
  let anyVisible = groupData.some(g => g.visible !== false);
  if (toggleNamesBtn)
    toggleNamesBtn.textContent = anyVisible ? "üôà Sembunyikan Semua Nama Rasi" : "üëÅÔ∏è Tampilkan Semua Nama Rasi";
}

// --- Event logic ---
function resetStars() {
  stars = [];
  connections = [];
  groupData = [];
  cachedGroups = null;
  hideContextMenu();
  draw();
  updateToggleNamesBtn();
}

// Context menu logic
function showContextMenu(x, y, starIdx) {
  detectGroups();
  contextStar = starIdx;
  contextGroupIdx = cachedGroups.starToGroup[starIdx];
  starMenuSection.style.display = starIdx !== null ? "block" : "none";
  constellationMenuSection.style.display = contextGroupIdx !== null ? "block" : "none";
  // update tombol toggle nama rasi per grup
  if (contextGroupIdx !== null) {
    let btn = document.getElementById("toggleNameGroupBtn");
    btn.textContent = (groupData[contextGroupIdx].visible !== false) ? "üôà Sembunyikan Nama Rasi Ini" : "üëÅÔ∏è Tampilkan Nama Rasi Ini";
  }
  contextMenu.style.left = x + "px";
  contextMenu.style.top = y + "px";
  contextMenu.style.display = "block";
}
function hideContextMenu() {
  contextMenu.style.display = "none";
  contextStar = null;
  contextGroupIdx = null;
}
function editSelectedStar() {
  if (contextStar !== null) {
    const newMsg = prompt("Ubah pesan:", stars[contextStar].message || "");
    if (newMsg !== null) stars[contextStar].message = newMsg;
    draw();
  }
  hideContextMenu();
}
function deleteSelectedStar() {
  if (contextStar !== null) {
    stars.splice(contextStar, 1);
    connections = connections
      .filter(([a, b]) => a !== contextStar && b !== contextStar)
      .map(([a, b]) => [
        a > contextStar ? a - 1 : a,
        b > contextStar ? b - 1 : b,
      ]);
    cachedGroups = null;
    draw();
  }
  hideContextMenu();
}
function startConnectingStars() {
  if (firstStar !== null) {
    firstStar = null;
    draw();
  } else if (contextStar !== null) {
    firstStar = contextStar;
    hideContextMenu();
    draw();
  }
}
function deleteConnectionsOfStar() {
  if (contextStar !== null) {
    connections = connections.filter(([a, b]) => a !== contextStar && b !== contextStar);
    cachedGroups = null;
    draw();
  }
  hideContextMenu();
}
function promptConstellationName() {
  if (contextGroupIdx !== null) {
    const name = prompt("Nama rasi bintang ini:", groupData[contextGroupIdx].name || "");
    if (name !== null) {
      groupData[contextGroupIdx].name = name;
      draw();
    }
  }
  hideContextMenu();
}
function removeConstellationName() {
  if (contextGroupIdx !== null) {
    if (groupData[contextGroupIdx].name) {
      if (confirm("Hapus nama rasi?")) {
        groupData[contextGroupIdx].name = "";
        draw();
      }
    }
  }
  hideContextMenu();
}
function changeConstellationColor() {
  if (contextGroupIdx !== null) {
    const color = prompt("Masukkan kode warna hex (mis: #FFD700):", groupData[contextGroupIdx].color || "#FFD700");
    if (color && /^#([0-9a-fA-F]{3}){1,2}$/.test(color)) {
      groupData[contextGroupIdx].color = color;
      draw();
    } else if (color) {
      alert("Format warna tidak valid. Gunakan hex seperti #FFD700");
    }
  }
  hideContextMenu();
}
function toggleConstellationName() {
  if (contextGroupIdx !== null) {
    groupData[contextGroupIdx].visible = !groupData[contextGroupIdx].visible;
    draw();
  }
  hideContextMenu();
}

// Helper: cari star di posisi tertentu
function findStarAt(x, y) {
  return stars.findIndex(star => {
    const dx = star.x - x;
    const dy = star.y - y;
    return Math.sqrt(dx * dx + dy * dy) < 10;
  });
}

// Double tap/double click
let lastTap = 0;
let tapTimeout;
canvas.addEventListener("pointerdown", (e) => {
  clearTimeout(tapTimeout);
  const now = Date.now();
  const { x, y } = { x: e.clientX, y: e.clientY };
  const starIdx = findStarAt(x, y);

  if (now - lastTap < 350) {
    // Double tap
    if (starIdx !== -1) {
      showContextMenu(e.clientX, e.clientY, starIdx);
    } else {
      const msg = prompt("Pesan untuk bintang ini (Bisa memasukkan link):");
      if (msg !== null) {
        stars.push({ x, y, message: msg });
        draw();
      }
    }
    lastTap = 0;
  } else {
    lastTap = now;
    tapTimeout = setTimeout(() => { lastTap = 0; }, 400);
  }
});

// Desktop double click
canvas.addEventListener("dblclick", (e) => {
  const { x, y } = { x: e.clientX, y: e.clientY };
  const starIdx = findStarAt(x, y);
  if (firstStar !== null && starIdx !== -1 && starIdx !== firstStar) {
    const { starToGroup } = detectGroups();
    const g1 = starToGroup[firstStar];
    const g2 = starToGroup[starIdx];
    if (g1 === null && g2 === null) {
      connections.push([firstStar, starIdx]);
      cachedGroups = null;
    } else if (g1 !== null && g2 === null) {
      connections.push([firstStar, starIdx]);
      cachedGroups = null;
    } else if (g1 === null && g2 !== null) {
      connections.push([firstStar, starIdx]);
      cachedGroups = null;
    } else if (g1 === g2) {
      connections.push([firstStar, starIdx]);
      cachedGroups = null;
    } else {
      alert("Tidak bisa menghubungkan dua bintang dari grup/rasi berbeda.");
    }
    firstStar = null;
    draw();
    return;
  }
  if (starIdx !== -1) {
    showContextMenu(e.clientX, e.clientY, starIdx);
  }
});

document.addEventListener("pointerdown", (e) => {
  if (contextMenu.style.display === "block" && !contextMenu.contains(e.target)) {
    hideContextMenu();
  }
});

canvas.addEventListener("pointermove", (e) => {
  const { x, y } = { x: e.clientX, y: e.clientY };
  const starIdx = findStarAt(x, y);
  if (starIdx !== -1) {
    starInfo.textContent = `Koordinat: (${stars[starIdx].x.toFixed(2)}, ${stars[starIdx].y.toFixed(2)})`;
    starInfo.innerHTML += `<br>Pesan: ${stars[starIdx].message || "Tidak ada pesan"}`;
    const infoRect = starInfo.getBoundingClientRect();
    let left = e.clientX + 10;
    let top = e.clientY - (infoRect.height || 40) - 10;
    if (top < 0) top = e.clientY + 20;
    if (left + (infoRect.width || 150) > window.innerWidth) {
      left = window.innerWidth - (infoRect.width || 150) - 10;
    }
    starInfo.style.left = left + "px";
    starInfo.style.top = top + "px";
    starInfo.style.display = "block";
  } else {
    starInfo.style.display = "none";
  }
});

function resizeCanvas() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  draw();
}
window.addEventListener("resize", resizeCanvas);
window.addEventListener("orientationchange", resizeCanvas);
resizeCanvas();

window.deleteConnectionsOfStar = deleteConnectionsOfStar;
window.editSelectedStar = editSelectedStar;
window.deleteSelectedStar = deleteSelectedStar;
window.startConnectingStars = startConnectingStars;
window.resetStars = resetStars;
window.promptConstellationName = promptConstellationName;
window.removeConstellationName = removeConstellationName;
window.changeConstellationColor = changeConstellationColor;
window.toggleConstellationName = toggleConstellationName;
window.toggleAllConstellationNames = toggleAllConstellationNames;
window.toggleControls = toggleControls;
</script>
</body>
</html>
