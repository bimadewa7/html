<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Constellation Creator 🌟</title>
  <style>
    body { margin: 0; overflow: hidden; background: radial-gradient(ellipse at bottom, #1b2735 0%, #090a0f 100%); font-family: Arial, sans-serif; color: white; touch-action: manipulation; }
    canvas { display: block; touch-action: none; }
    #messageBox, #starMenu {
      position: absolute;
      background: rgba(255,255,255,0.95);
      color: #000;
      border-radius: 6px;
      padding: 8px;
      font-size: 14px;
      display: none;
      z-index: 10;
    }
    #starMenu button {
      display: block;
      width: 100%;
      background: none;
      border: none;
      padding: 6px;
      text-align: left;
      cursor: pointer;
    }
    #starMenu button:hover { background: #f0f0f0; }
    #closeStarMenu {
      position: absolute; top: 5px; right: 5px;
      background: #ff5555; color: white; border-radius: 50%;
      width: 25px; height: 25px; font-size: 18px; cursor: pointer;
      text-align: center; line-height: 25px;
    }
    #controls {
      position: absolute;
      top: 10px; left: 10px;
      background: rgba(0,0,0,0.6);
      padding: 10px; border-radius: 8px; z-index: 5;
    }
    button { background: #fff; border: none; border-radius: 5px; padding: 5px 10px; margin: 4px 0; font-size: 14px; cursor: pointer; }
    button:hover { background: #ffcccb; }
    #starInfo {
      position: absolute; background: rgba(0, 0, 0, 0.6);
      color: white; padding: 10px; font-size: 12px;
      border-radius: 5px; display: none; z-index: 15;
    }
    .highlighted { fill: #FF0 !important; stroke: #FF0 !important; stroke-width: 2; }
    .star { filter: drop-shadow(0 0 12px #fff) drop-shadow(0 0 24px #fff) drop-shadow(0 0 36px #ff0); transition: filter 0.2s; }
    @media (max-width: 600px) {
      #controls { top: 0; left: 0; width: 100vw; font-size: 4vw; padding: 4vw 2vw; border-radius: 0 0 12px 12px; }
      button { font-size: 4vw; padding: 3vw 6vw; }
      #starInfo { font-size: 3vw; padding: 3vw; }
      #starMenu, #messageBox { font-size: 4vw; padding: 3vw; }
      #closeStarMenu { width: 8vw; height: 8vw; font-size: 6vw; line-height: 8vw; }
    }
  </style>
</head>
<body>
<canvas id="sky"></canvas>
<div id="messageBox"></div>
<div id="starMenu">
  <button id="editStarMsg">✏️ Edit Pesan Bintang</button>
  <button id="deleteStarBtn">🗑️ Hapus Bintang</button>
  <button id="connectStarBtn">🔗 Sambung Bintang</button>
  <button id="deleteStarConns">❌ Hapus Sambungan</button>
  <hr>
  <button id="editRasiName">✏️ Edit/Tambah Nama Rasi</button>
  <button id="editRasiColor">🎨 Ubah Warna Nama Rasi</button>
  <button id="deleteRasiName">🗑️ Hapus Nama Rasi</button>
  <div id="closeStarMenu">X</div>
</div>
<div id="controls">
  ✨ 2x Tap/Klik untuk menambah bintang<br>
  ❌ 2x Tap/Klik pada bintang = Menu Bintang & Rasi<br>
  🔗 Pilih Sambung Bintang lalu tekan bintang kedua<br>
  <button onclick="resetStars()">🔄 Reset Semua</button>
  <button onclick="toggleConstellationNames()">🌌 Tampil/Sembunyi Nama/Isi Rasi</button>
</div>
<div id="starInfo"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAn9lNzZsWyF76P5_XhTe-aO7yGYnhH9Ak",
  authDomain: "constellation-b1844.firebaseapp.com",
  databaseURL: "https://constellation-b1844-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "constellation-b1844",
  storageBucket: "constellation-b1844.appspot.com",
  messagingSenderId: "31660084862",
  appId: "1:31660084862:web:0c2f9301819de7a540922f",
  measurementId: "G-ZFYHDD1EY0"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const canvas = document.getElementById("sky");
const ctx = canvas.getContext("2d");

// Background size & min zoom
let bgWidth = 2400, bgHeight = 1600;
const MIN_SCALE = Math.max(window.innerWidth / bgWidth, window.innerHeight / bgHeight);
const MAX_SCALE = 5;

// Data
let stars = [];
let connections = [];
let showNames = false;
let showMessages = false;
let rasiGroups = [];
let firstStar = null;
let selectedStarIdx = null;
const messageBox = document.getElementById("messageBox");
const starMenu = document.getElementById("starMenu");
const starInfo = document.getElementById("starInfo");

// Zoom & pan
let scale = MIN_SCALE, offsetX = 0, offsetY = 0, isDragging = false, lastX = 0, lastY = 0;

window.toggleConstellationNames = function() {
  if (!showNames && !showMessages) {
    showNames = true;
    showMessages = false;
  } else if (showNames && !showMessages) {
    showNames = true;
    showMessages = true;
  } else {
    showNames = false;
    showMessages = false;
  }
  draw();
};

function draw() {
  // ======= BACKGROUND: hanya gradient (tanpa bintik) =======
  ctx.setTransform(1, 0, 0, 1, 0, 0);
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // Semua objek utama di-zoom/pan
  ctx.setTransform(scale, 0, 0, scale, offsetX, offsetY);

  // Draw connections
  ctx.strokeStyle = "rgba(255, 255, 255, 0.3)";
  ctx.lineWidth = 1.5;
  connections.forEach(([a, b]) => {
    ctx.beginPath();
    ctx.moveTo(a.x, a.y);
    ctx.lineTo(b.x, b.y);
    ctx.stroke();
  });
  // Draw stars (big)
  stars.forEach(star => {
    ctx.save();
    if (!star.highlighted) {
      ctx.shadowColor = "#fff";
      ctx.shadowBlur = 18;
    } else {
      ctx.shadowColor = "#FF0";
      ctx.shadowBlur = 24;
    }
    ctx.beginPath();
    ctx.arc(star.x, star.y, 5, 0, Math.PI * 2);
    ctx.fillStyle = star.highlighted ? "#FF0" : "white";
    ctx.fill();
    ctx.restore();
  });

  if (showNames) {
    rasiGroups.forEach(grp => {
      if (grp.name && grp.starIdxs.length) {
        const starOrder = [...grp.starIdxs].sort((a,b)=>a-b);
        let minX=Infinity,maxX=-Infinity,minY=Infinity,maxY=-Infinity;
        grp.starIdxs.forEach(idx=>{
          const s = stars[idx];
          minX = Math.min(minX, s.x); maxX = Math.max(maxX,s.x);
          minY = Math.min(minY, s.y); maxY = Math.max(maxY,s.y);
        });
        ctx.save();
        ctx.textAlign = "center";
        const centerX = (minX+maxX)/2;
        let rasiWidth = Math.max(1, maxX - minX);
        let fontSize = Math.max(18, Math.min(38, Math.round(rasiWidth / 8)));
        ctx.font = `bold ${fontSize}px Arial`;
        ctx.fillStyle = grp.color || "#FFD700";
        const paddingNameToStars = 46;
        const paddingMsgToStars = 22;
        ctx.fillText(grp.name, centerX, minY - paddingNameToStars);
        if (showMessages) {
          const msgJoin = starOrder.map(idx => (stars[idx].message||"").trim()).filter(Boolean).join(' ');
          ctx.font = "14px Arial";
          ctx.fillStyle = "#fff";
          ctx.fillText(msgJoin ? `"${msgJoin}"` : '', centerX, minY - paddingMsgToStars);
        }
        ctx.restore();
      }
    });
  }
}

function resizeCanvas() {
  const dpr = window.devicePixelRatio || 1;
  canvas.width = window.innerWidth * dpr;
  canvas.height = window.innerHeight * dpr;
  canvas.style.width = window.innerWidth + "px";
  canvas.style.height = window.innerHeight + "px";
  ctx.setTransform(1, 0, 0, 1, 0, 0);
  ctx.scale(dpr, dpr);

  // Atur minimal zoom agar background selalu menutupi layar
  scale = Math.max(window.innerWidth / bgWidth, window.innerHeight / bgHeight);
  offsetX = 0; offsetY = 0;
  draw();
}
window.addEventListener("resize", resizeCanvas);
window.addEventListener("orientationchange", resizeCanvas);
resizeCanvas();

function saveToFirebase() {
  set(ref(db, "constellations"), {
    stars: stars.map(s => ({ x: s.x, y: s.y, message: s.message })),
    connections: connections.map(([a, b]) => [stars.indexOf(a), stars.indexOf(b)]),
    rasiGroups: rasiGroups.map(g=>({starIdxs:[...g.starIdxs],name:g.name||"",color:g.color||"#FFD700"}))
  });
}
function loadFromFirebase() {
  onValue(ref(db, "constellations"), (snapshot) => {
    const data = snapshot.val();
    if (data) {
      stars = data.stars.map(s => ({ ...s }));
      connections = data.connections.map(([i1, i2]) => [stars[i1], stars[i2]]);
      rasiGroups = (data.rasiGroups || []).map(g=>({
        starIdxs: g.starIdxs || [],
        name: g.name || "",
        color: g.color || "#FFD700"
      }));
      draw();
    }
  });
}
loadFromFirebase();

function resetStars() {
  stars = [];
  connections = [];
  rasiGroups = [];
  firstStar = null;
  hideStarMenu();
  saveToFirebase();
  draw();
}

function updateRasiGroups() {
  let parents = Array(stars.length).fill(0).map((_,i)=>i);
  function find(x){return parents[x]===x?x:parents[x]=find(parents[x]);}
  function union(x,y){parents[find(x)]=find(y);}
  connections.forEach(([a,b])=>{
    const ai = stars.indexOf(a), bi = stars.indexOf(b);
    if(ai!==-1&&bi!==-1) union(ai,bi);
  });
  const groupMap = {};
  for(let i=0;i<stars.length;i++){
    const p = find(i);
    if(!groupMap[p]) groupMap[p]=[];
    groupMap[p].push(i);
  }
  let newGroups = Object.values(groupMap).map(starIdxs=>{
    let found = rasiGroups.find(g=>g.starIdxs.length===starIdxs.length && g.starIdxs.every(i=>starIdxs.includes(i)));
    return {
      starIdxs,
      name: found?found.name:"",
      color: found?found.color:"#FFD700"
    };
  });
  rasiGroups = newGroups;
}

function findStarAt(x, y) {
  return stars.find(star => {
    const dx = star.x - x;
    const dy = star.y - y;
    return Math.sqrt(dx * dx + dy * dy) < 10;
  });
}
function findStarIdxAt(x, y) {
  for (let i=0;i<stars.length;i++) {
    const dx = stars[i].x - x;
    const dy = stars[i].y - y;
    if (Math.sqrt(dx*dx+dy*dy)<10) return i;
  }
  return -1;
}
function showStarMenu(x, y, idx) {
  selectedStarIdx = idx;
  starMenu.style.left = x + "px";
  starMenu.style.top = y + "px";
  starMenu.style.display = "block";
}
function hideStarMenu() {
  starMenu.style.display = "none";
  selectedStarIdx = null;
}
document.getElementById("closeStarMenu").onclick = hideStarMenu;
document.addEventListener("pointerdown", (e) => {
  if (starMenu.style.display === "block" && !starMenu.contains(e.target)) hideStarMenu();
});
document.getElementById("editStarMsg").onclick = function() {
  if(selectedStarIdx!=null){
    const newMsg = prompt("Ubah pesan bintang:", stars[selectedStarIdx].message||"");
    if(newMsg!==null) {
      stars[selectedStarIdx].message = newMsg;
      saveToFirebase(); draw();
    }
  }
  hideStarMenu();
};
document.getElementById("deleteStarBtn").onclick = function() {
  if(selectedStarIdx!=null){
    const star = stars[selectedStarIdx];
    stars.splice(selectedStarIdx,1);
    let removeIndexes = [];
    connections.forEach(([a, b], idx) => {
      if (a === star || b === star) removeIndexes.push(idx);
    });
    removeIndexes.sort((a, b) => b - a).forEach(idx => { connections.splice(idx, 1); });
    updateRasiGroups();
    saveToFirebase(); draw();
  }
  hideStarMenu();
};
document.getElementById("connectStarBtn").onclick = function() {
  if(selectedStarIdx!=null){
    if(firstStar) firstStar.highlighted = false;
    firstStar = stars[selectedStarIdx];
    firstStar.highlighted = true;
    hideStarMenu();
    draw();
  }
};
document.getElementById("deleteStarConns").onclick = function() {
  if(selectedStarIdx!=null){
    const star = stars[selectedStarIdx];
    let removeIndexes = [];
    connections.forEach(([a, b], idx) => {
      if (a === star || b === star) removeIndexes.push(idx);
    });
    removeIndexes.sort((a, b) => b - a).forEach(idx => { connections.splice(idx, 1); });
    updateRasiGroups();
    saveToFirebase(); draw();
  }
  hideStarMenu();
};

function getRasiIdxByStarIdx(idx) {
  return rasiGroups.findIndex(g=>g.starIdxs.includes(idx));
}
document.getElementById("editRasiName").onclick = function() {
  let rasiIdx = getRasiIdxByStarIdx(selectedStarIdx);
  if(rasiIdx!=-1){
    let nama = prompt("Nama rasi:", rasiGroups[rasiIdx].name||"");
    if(nama!==null) {
      rasiGroups[rasiIdx].name = nama;
      saveToFirebase(); draw();
    }
  }
  hideStarMenu();
};
document.getElementById("editRasiColor").onclick = function() {
  let rasiIdx = getRasiIdxByStarIdx(selectedStarIdx);
  if(rasiIdx!=-1){
    let warna = prompt("Warna nama rasi (hex/namacolor):", rasiGroups[rasiIdx].color||"#FFD700");
    if(warna!==null) {
      rasiGroups[rasiIdx].color = warna;
      saveToFirebase(); draw();
    }
  }
  hideStarMenu();
};
document.getElementById("deleteRasiName").onclick = function() {
  let rasiIdx = getRasiIdxByStarIdx(selectedStarIdx);
  if(rasiIdx!=-1){
    rasiGroups[rasiIdx].name="";
    saveToFirebase(); draw();
  }
  hideStarMenu();
};

canvas.addEventListener("pointerup", (e) => {
  if (firstStar) {
    const { x, y } = toCanvasCoords(e.clientX, e.clientY);
    const clickedStar = findStarAt(x, y);
    if (clickedStar && clickedStar !== firstStar) {
      connections.push([firstStar, clickedStar]);
      firstStar.highlighted = false;
      firstStar = null;
      updateRasiGroups();
      saveToFirebase();
      draw();
      return;
    }
  }
});

canvas.addEventListener("dblclick", (e) => {
  if (firstStar) return;
  const { x, y } = toCanvasCoords(e.clientX, e.clientY);
  const starIdx = findStarIdxAt(x, y);
  if (starIdx != -1) {
    showStarMenu(e.clientX, e.clientY, starIdx);
    return;
  }
  const msg = prompt("Pesan untuk bintang ini (Bisa memasukkan link):");
  if (msg !== null) {
    stars.push({ x, y, message: msg });
    updateRasiGroups();
    saveToFirebase();
    draw();
  }
});
let lastTapTime = 0;
canvas.addEventListener("touchend", (e) => {
  if (firstStar) {
    const touch = e.changedTouches[0];
    const { x, y } = toCanvasCoords(touch.clientX, touch.clientY);
    const clickedIdx = findStarIdxAt(x, y);
    if (clickedIdx !== -1 && stars[clickedIdx] !== firstStar) {
      connections.push([firstStar, stars[clickedIdx]]);
      firstStar.highlighted = false;
      firstStar = null;
      updateRasiGroups();
      saveToFirebase();
      draw();
      return;
    }
  } else if (e.touches.length === 0) {
    const now = Date.now();
    if (now - lastTapTime < 400) {
      const touch = e.changedTouches[0];
      const { x, y } = toCanvasCoords(touch.clientX, touch.clientY);
      const starIdx = findStarIdxAt(x, y);
      if (starIdx != -1) {
        showStarMenu(touch.clientX, touch.clientY, starIdx);
        lastTapTime = 0;
        return;
      }
      const msg = prompt("Pesan untuk bintang ini (Bisa memasukkan link):");
      if (msg !== null) {
        stars.push({ x, y, message: msg });
        updateRasiGroups();
        saveToFirebase();
        draw();
      }
    }
    lastTapTime = now;
  }
});

canvas.addEventListener("pointermove", (e) => {
  const { x, y } = toCanvasCoords(e.clientX, e.clientY);
  const hoveredStar = findStarAt(x, y);
  if (hoveredStar) {
    starInfo.textContent = `Koordinat: (${hoveredStar.x.toFixed(2)}, ${hoveredStar.y.toFixed(2)})`;
    starInfo.innerHTML += `<br>Pesan: ${hoveredStar.message || "Tidak ada pesan"}`;
    const infoRect = starInfo.getBoundingClientRect();
    let left = e.clientX + 10;
    let top = e.clientY - (infoRect.height || 40) - 10;
    if (top < 0) top = e.clientY + 20;
    if (left + (infoRect.width || 150) > window.innerWidth) {
      left = window.innerWidth - (infoRect.width || 150) - 10;
    }
    starInfo.style.left = left + "px";
    starInfo.style.top = top + "px";
    starInfo.style.display = "block";
  } else {
    starInfo.style.display = "none";
  }
});

window.resetStars = resetStars;

canvas.addEventListener("wheel", (e) => {
  e.preventDefault();
  const mouse = toCanvasCoords(e.clientX, e.clientY);
  const zoom = e.deltaY < 0 ? 1.1 : 0.9;
  scale *= zoom;
  scale = Math.max(MIN_SCALE, Math.min(MAX_SCALE, scale));
  offsetX = e.clientX - (mouse.x * scale);
  offsetY = e.clientY - (mouse.y * scale);
  draw();
}, { passive: false });

let lastDist = null;
canvas.addEventListener("touchmove", (e) => {
  if (e.touches.length === 2) {
    const dx = e.touches[0].clientX - e.touches[1].clientX;
    const dy = e.touches[0].clientY - e.touches[1].clientY;
    const dist = Math.sqrt(dx * dx + dy * dy);
    if (lastDist) {
      const zoom = dist / lastDist;
      const centerX = (e.touches[0].clientX + e.touches[1].clientX) / 2;
      const centerY = (e.touches[0].clientY + e.touches[1].clientY) / 2;
      const center = toCanvasCoords(centerX, centerY);
      scale *= zoom;
      scale = Math.max(MIN_SCALE, Math.min(MAX_SCALE, scale));
      offsetX = centerX - (center.x * scale);
      offsetY = centerY - (center.y * scale);
      draw();
    }
    lastDist = dist;
  }
});
canvas.addEventListener("touchend", (e) => {
  if (e.touches.length < 2) lastDist = null;
});

canvas.addEventListener("pointerdown", (e) => {
  if (e.button === 1 || (e.pointerType === "touch" && !findStarAt(...Object.values(toCanvasCoords(e.clientX, e.clientY))))) {
    isDragging = true;
    lastX = e.clientX;
    lastY = e.clientY;
  }
});
canvas.addEventListener("pointermove", (e) => {
  if (isDragging) {
    offsetX += e.clientX - lastX;
    offsetY += e.clientY - lastY;
    lastX = e.clientX;
    lastY = e.clientY;
    draw();
  }
});
canvas.addEventListener("pointerup", () => { isDragging = false; });
canvas.addEventListener("touchstart", (e) => {
  if (e.touches.length === 2) return;
  if (e.touches.length === 1) {
    isDragging = true;
    lastX = e.touches[0].clientX;
    lastY = e.touches[0].clientY;
  }
});
canvas.addEventListener("touchmove", (e) => {
  if (isDragging && e.touches.length === 1) {
    offsetX += e.touches[0].clientX - lastX;
    offsetY += e.touches[0].clientY - lastY;
    lastX = e.touches[0].clientX;
    lastY = e.touches[0].clientY;
    draw();
  }
});
canvas.addEventListener("touchend", () => { isDragging = false; });

function toCanvasCoords(x, y) {
  return { x: (x - offsetX) / scale, y: (y - offsetY) / scale };
}
</script>
</body>
</html>
